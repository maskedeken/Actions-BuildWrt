diff -ur a/package/feeds/luci/luci-app-ssr-plus/root/usr/bin/ssr-rules b/package/feeds/luci/luci-app-ssr-plus/root/usr/bin/ssr-rules
--- a/package/feeds/luci/luci-app-ssr-plus/root/usr/bin/ssr-rules	2023-04-06 09:29:59.193322798 +0800
+++ b/package/feeds/luci/luci-app-ssr-plus/root/usr/bin/ssr-rules	2023-04-06 09:28:22.149991305 +0800
@@ -84,7 +84,9 @@
 ipset_r() {
 	[ -f "$IGNORE_LIST" ] && /usr/share/shadowsocksr/chinaipset.sh $IGNORE_LIST
 	$IPT -N SS_SPEC_WAN_AC
-	$IPT -I SS_SPEC_WAN_AC -p tcp ! --dport 53 -d $server -j RETURN
+	if [ "$server" != "ERROR" ];then
+		$IPT -I SS_SPEC_WAN_AC -p tcp ! --dport 53 -d $server -j RETURN
+	fi
 	ipset -N gmlan hash:net 2>/dev/null
 	for ip in $LAN_GM_IP; do ipset -! add gmlan $ip; done
 	case "$RUNMODE" in
@@ -93,6 +95,11 @@
 			create ss_spec_wan_ac hash:net
 			$(gen_spec_iplist | sed -e "s/^/add ss_spec_wan_ac /")
 		EOF
+		[ "$server" != "ERROR" ] && ipset -! add ss_spec_wan_ac $server
+		[ "$SERVER" != "ERROR" ] && ipset -! add ss_spec_wan_ac $SERVER
+		ipset -! -R <<-EOF
+			$(get_wan_ip | sed -e "s/^/add ss_spec_wan_ac /")
+		EOF
 		$IPT -A SS_SPEC_WAN_AC -m set --match-set ss_spec_wan_ac dst -j RETURN
 		$IPT -A SS_SPEC_WAN_AC -m set --match-set china dst -j RETURN
 		$IPT -A SS_SPEC_WAN_AC -m set --match-set gmlan src -m set ! --match-set china dst -j SS_SPEC_WAN_FW
@@ -205,6 +212,11 @@
 			create ssr_gen_router hash:net
 			$(gen_spec_iplist | sed -e "s/^/add ssr_gen_router /")
 		EOF
+		[ "$server" != "ERROR" ] && ipset -! add ssr_gen_router $server
+		[ "$SERVER" != "ERROR" ] && ipset -! add ssr_gen_router $SERVER
+		ipset -! -R <<-EOF
+			$(get_wan_ip | sed -e "s/^/add ssr_gen_router /")
+		EOF
 		$IPT -N SS_SPEC_ROUTER && \
 		$IPT -A SS_SPEC_ROUTER -m set --match-set ssr_gen_router dst -j RETURN && \
 		$IPT -A SS_SPEC_ROUTER -j SS_SPEC_WAN_FW
@@ -229,8 +241,12 @@
 	$ipt -A SS_SPEC_TPROXY -p udp -d 192.168.0.0/16 -j RETURN
 	$ipt -A SS_SPEC_TPROXY -p udp -d 224.0.0.0/4 -j RETURN
 	$ipt -A SS_SPEC_TPROXY -p udp -d 240.0.0.0/4 -j RETURN
-	$ipt -A SS_SPEC_TPROXY -p udp ! --dport 53 -d $SERVER -j RETURN
-	[ "$server" != "$SERVER" ] && ipset -! add whitelist $SERVER
+	if [ "$SERVER" != "ERROR" ];then
+		$ipt -A SS_SPEC_TPROXY -p udp ! --dport 53 -d $SERVER -j RETURN
+		ipset -! add whitelist $SERVER
+	fi
+	$ipt -A SS_SPEC_TPROXY -p udp -m set --match-set whitelist dst -j RETURN
+	$ipt -A SS_SPEC_TPROXY -p udp $PROXY_PORTS -m set --match-set blacklist dst -j TPROXY --on-port "$LOCAL_PORT" --tproxy-mark 0x01/0x01
 	$ipt -A SS_SPEC_TPROXY -p udp -m set --match-set bplan src -j RETURN
 	$ipt -A SS_SPEC_TPROXY -p udp $PROXY_PORTS -m set --match-set fplan src -j TPROXY --on-port "$LOCAL_PORT" --tproxy-mark 0x01/0x01
 	case "$RUNMODE" in
@@ -272,8 +288,6 @@
 
 get_wan_ip() {
 	cat <<-EOF | grep -E "^([0-9]{1,3}\.){3}[0-9]{1,3}"
-		$server
-		$SERVER
 		$WAN_BP_IP
 	EOF
 }
@@ -296,7 +310,6 @@
 		224.0.0.0/4
 		240.0.0.0/4
 		255.255.255.255
-		$(get_wan_ip)
 	EOF
 }
 
